generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id            String   @id @default(uuid())
    email         String   @unique
    password_hash String
    name          String
    role          Role     @default(USER)
    status        Status   @default(ACTIVE)
    language      String   @default("pt-br")
    created_at    DateTime @default(now())
    updated_at    DateTime @updatedAt
    last_login    DateTime?

    subscriptions Subscription[]
}

model Plan {
    id            String   @id @default(uuid())
    name          String
    description   String?
    price         Decimal  @db.Decimal(10, 2)
    duration_days Int      // 0 = perp√©tuo, 30, 90, 365
    status        Status   @default(ACTIVE)
    created_at    DateTime @default(now())
    updated_at    DateTime @updatedAt

    plan_bots     PlanBot[]
    subscriptions Subscription[]
}

model Bot {
    id            String   @id @default(uuid())
    name          String
    description   String?
    xml_filename  String
    category      BotCategory @default(PAID)
    status        Status   @default(ACTIVE)
    created_at    DateTime @default(now())
    updated_at    DateTime @updatedAt

    plan_bots     PlanBot[]
}

model PlanBot {
    id      String @id @default(uuid())
    plan_id String
    bot_id  String

    plan    Plan   @relation(fields: [plan_id], references: [id], onDelete: Cascade)
    bot     Bot    @relation(fields: [bot_id], references: [id], onDelete: Cascade)

    @@unique([plan_id, bot_id])
}

model Subscription {
    id                String   @id @default(uuid())
    user_id           String
    plan_id           String
    started_at        DateTime @default(now())
    expires_at        DateTime?
    status            SubscriptionStatus @default(ACTIVE)
    payment_source    PaymentSource @default(MANUAL)
    payment_reference String?
    created_at        DateTime @default(now())
    updated_at        DateTime @updatedAt

    user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
    plan              Plan     @relation(fields: [plan_id], references: [id])
}

model CourseModule {
    id          String   @id @default(uuid())
    title       String
    description String?
    banner_url  String?
    order       Int      @default(0)
    status      Status   @default(ACTIVE)
    created_at  DateTime @default(now())
    updated_at  DateTime @updatedAt

    lessons     CourseLesson[]
}

model CourseLesson {
    id          String   @id @default(uuid())
    module_id   String
    title       String
    youtube_url String
    order       Int      @default(0)
    status      Status   @default(ACTIVE)
    created_at  DateTime @default(now())
    updated_at  DateTime @updatedAt

    module      CourseModule @relation(fields: [module_id], references: [id], onDelete: Cascade)
}

model WebhookLog {
    id           String   @id @default(uuid())
    source       String   // perfectpay, hotmart, stripe
    payload      Json
    status       String   @default("received")
    processed_at DateTime?
    created_at   DateTime @default(now())
}

model Setting {
    id    String @id @default(uuid())
    key   String @unique
    value String
}

enum Role {
    USER
    ADMIN
    MASTER
}

enum Status {
    ACTIVE
    INACTIVE
    BLOCKED
    PENDING
}

enum SubscriptionStatus {
    ACTIVE
    EXPIRED
    CANCELLED
}

enum PaymentSource {
    MANUAL
    PERFECTPAY
    HOTMART
    STRIPE
}

enum BotCategory {
    FREE
    PAID
    BONUS
}
